# Bosch BMV080 Driver

## Overview

This driver is used to initialize and configure a [Bosch BMV080 sensor](https://www.bosch-sensortec.com/products/environmental-sensors/particulate-matter-sensor/bmv080/), and retrieve particulate matter (PM) air quality data. Communication with the sensor takes place over I2C, using an I2C handle created with the STM32 HAL.

The driver relies on static compiled library files `lib_bmv080.a` and `lib_postProcessor.a` provided by Bosch, as Bosch does not provide documentation for directly interfacing with the sensor. In addition, the static libraries make use of `float` values, so users of this driver should be aware that software floating point operations will take place in the absense of an FPU.

### Driver Structure

As noted above, this driver relies on statically compiled code provided by Bosch, in files `lib_bmv080.a` and `lib_postProcessor.a`, and related header files `bmv080_defs.h` and `bmv080.h`. The Bosch code may be requested from Bosch through their [website SDK request form](https://www.bosch-sensortec.com/software-tools/double-opt-in-forms/sdk-v11-1.html).

The Bosch-provided SDK code includes STM32 example implementations as well as the static libraries. This code was referenced in creation of the callback functions for I2C read and write, as well the the delay callback.

### Example Usage

The following example shows creation and initialization of a `bmv080_sensor_t` struct, which contains a pointer to an I2C handle previously initialized in application code.

```c
#include "bmv080_driver.h"

int main(void) {
  bmv080_sensor_t bmv080;
  bmv080_init(&bmv080, &hi2c1);
  bmv080_configure_duty_cycle(&bmv080, 20); // 20 second cycle
  if (bmv080.status != E_BMV080_OK)
    printf("Failed to configure duty cycle: %d\r\n", bmv080.status);
  bmv080_start_duty_cycle(&bmv080);

  while (1)
  {
    if (bmv080_poll(&bmv080) == E_BMV080_OK && bmv080.data_available)
    {
      // Floating point output
      bmv080_print_output(&bmv080.output);

      // Convert to fixed-point representation
      bmv080_fixed_t fixed = bmv080_to_fixed(&bmv080.output);

      // Print fixed-point values (example)
      debug_print("Fixed output: runtime=%u (0.01s), PM1=%u, PM2.5=%u, PM10=%u, flags=0x%02X\r\n",
                        fixed.runtime_in_0_01_sec,
                        fixed.pm1,
                        fixed.pm2_5,
                        fixed.pm10,
                        fixed.flags);

      bmv080.data_available = false;
      debug_print("\r\n");
    }
    HAL_Delay(100); // Polling period
  }
}

```


## Driver API

### `bmv080_sensor_t` struct

Structure to store necessary configuration and data to interact with the sensor over I2C.

### `bmv080_fixed_t` struct

Structure to store scaled fixed point output values as `uint16_t` values. This reduced-size format may be helpful for transporting values.

### `bmv080_init()`

Configures the sensor with default settings.

**Parameters:**
- `sensor`: Pointer to newly initialized BMV080 sensor interface
- `i2c_handle`: Pointer to I2C handle

TODO: Add docs for other functions
